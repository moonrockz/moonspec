{"id":"moonspec-0x4","title":"Formatter: JUnit XML output","description":"Implement JUnitFormatter that buffers results and writes standard JUnit XML on on_run_finish. Map features to testsuites, scenarios to testcases. Include failure messages and timing.","status":"closed","priority":2,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:29Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["format"],"dependencies":[{"issue_id":"moonspec-0x4","depends_on_id":"moonspec-o9h","type":"blocks","created_at":"2026-02-21T17:15:44Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-1e8","title":"Refactor execution pipeline: parse-once discovery with in-memory feature cache","description":"## Problem\n\nThe current execution pipeline parses feature files multiple times:\n\n1. **Codegen phase** (`codegen.mbt:151`): Parses each `.feature` file to extract structure for test generation\n2. **Runtime phase** (`feature.mbt:7,13`): Re-parses the same content during test execution:\n   - `FeatureSource::Text(str)` → parses embedded string again\n   - `FeatureSource::File(path)` → re-reads from disk and parses again\n3. **PerScenario codegen mode** (`codegen.mbt:292-314`): Embeds the entire feature file content as a multiline string literal in EACH generated test — so a feature with 10 scenarios has the full feature text duplicated 10 times in the generated code\n4. **Parallel execution** (`parallel.mbt`): Each parallel async task independently parses its input with no shared cache\n\n## Research: How Cucumber Frameworks Handle This\n\nAll major cucumber frameworks (cucumber-js, behave, cucumber-rs) follow the same pattern:\n\n```\nDiscovery → Parse Once → [In-Memory Representation] → Filter → Execute → Report\n```\n\n### Key principles:\n- **Parse once, execute from memory**: Feature files are parsed exactly once during an upfront discovery phase. The parsed representation is the sole input to execution.\n- **Separation of parsing from execution**: Parsing produces an intermediate representation (Pickles in cucumber-js, Feature model objects in behave, Feature structs in cucumber-rs). The executor never touches raw Gherkin text.\n- **Example expansion before execution**: Scenario Outlines are expanded into concrete scenarios before execution begins.\n- **Step matching at execution time**: Step definitions are resolved during execution, not during parsing.\n\n### Framework-specific approaches:\n- **cucumber-js**: `loadSources()` discovers + parses all features → Pickle Compiler flattens into execution-ready Pickles → Runtime iterates Pickles\n- **behave**: `collect_feature_locations()` discovers → `parse_features()` groups by filename and parses each unique file once → `self.features` list is iterated by `run_model()`\n- **cucumber-rs**: `Basic` parser globs for features → `gherkin::Feature::parse_path()` + `.expand_examples()` → async Stream consumed once by Runner\n\n## Proposed Solution\n\nRefactor the moonspec execution pipeline to follow the standard cucumber architecture:\n\n### Phase 1: Discovery\n- Add a `discover_features(paths: Array[String]) -\u003e Array[String]` function that walks directories and collects `.feature` file paths\n- Support glob patterns for flexible discovery\n\n### Phase 2: Parse Once + Cache\n- Add a `FeatureCache` type (essentially `Map[String, @gherkin.Feature]` keyed by file path)\n- Parse each discovered feature file exactly once into the cache\n- Expand Scenario Outlines at parse time (already partially done in `scenario_outline.mbt`)\n\n### Phase 3: Execution from Cache\n- Modify the runner to accept `FeatureCache` (or `Array[@gherkin.Feature]`) instead of `Array[FeatureSource]`\n- Remove `FeatureSource::Text` and `FeatureSource::File` variants (or deprecate them)\n- Default to `FeatureSource::Parsed` path which skips re-parsing\n- Parallel execution shares the same parsed cache (read-only)\n\n### Phase 4: Codegen Alignment\n- Codegen should emit `FeatureSource::Parsed(...)` or reference the cache\n- Stop embedding full feature text as string literals in generated test files\n- Instead, generate code that references the pre-parsed feature from the cache\n\n## Files Affected\n- `moonspec/src/runner/feature.mbt` — `resolve_feature()` and `execute_feature_filtered()`\n- `moonspec/src/runner/run.mbt` — Entry points `run`, `run_with_hooks`\n- `moonspec/src/runner/parallel.mbt` — Parallel execution\n- `moonspec/src/runner/results.mbt` — `FeatureSource` enum definition\n- `moonspec/src/codegen/codegen.mbt` — Test file generation\n- `moonspec/src/cmd/main/main.mbt` — CLI commands (discovery integration)\n- New file: `moonspec/src/runner/cache.mbt` or `moonspec/src/runner/discovery.mbt`\n\n## Acceptance Criteria\n- [ ] Feature files are parsed exactly once per test run\n- [ ] In-memory cache/collection holds parsed Features for the duration of execution\n- [ ] Parallel execution shares parsed features (no re-parsing per task)\n- [ ] Generated test files no longer embed full feature content as strings\n- [ ] Existing tests continue to pass\n- [ ] `FeatureSource::Parsed` is the primary execution path","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-22T09:14:31Z","created_by":"Damian Reeves","updated_at":"2026-02-22T10:34:01Z","closed_at":"2026-02-22T10:34:01Z","close_reason":"Implemented parse-once pickle pipeline: FeatureCache, Pickle compiler, PickleFilter, refactored runner, updated codegen","labels":["refactor","runner"]}
{"id":"moonspec-1ke","title":"DataTable support in step arguments","description":"Support DataTable arguments in step definitions. When a Gherkin step has an attached data table, it should be accessible to the step handler as a structured argument. This was part of the original moonspec-mlp issue.","status":"open","priority":2,"issue_type":"feature","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-23T00:29:42Z","created_by":"Damian Reeves","updated_at":"2026-02-23T00:29:42Z"}
{"id":"moonspec-24j","title":"Codegen: Generate _test.mbt from .feature files","description":"Implement generate() that reads .feature files via moonrockz/gherkin, produces _test.mbt files with one test block per scenario. Include staleness detection via source hash in header comment. Handle Scenario Outline expansion into individual test blocks.","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:29Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["codegen"],"dependencies":[{"issue_id":"moonspec-24j","depends_on_id":"moonspec-cmq","type":"blocks","created_at":"2026-02-21T17:15:44Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-2sy","title":"Runner: Result types","description":"Define StepStatus (Passed, Failed, Skipped, Undefined, Pending), StepResult, ScenarioResult, FeatureResult, RunResult, RunSummary. These are consumed by formatters.","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:25Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["runner"],"dependencies":[{"issue_id":"moonspec-2sy","depends_on_id":"moonspec-kkv","type":"blocks","created_at":"2026-02-21T17:15:38Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-3qp","title":"Runner: Parallel scenario execution","description":"Support running scenarios concurrently when config.parallel is true. Each scenario gets its own World instance so there are no shared state issues. Collect results from all scenarios.","status":"closed","priority":3,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:26Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["runner"],"dependencies":[{"issue_id":"moonspec-3qp","depends_on_id":"moonspec-cmq","type":"blocks","created_at":"2026-02-21T17:15:41Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-4ig","title":"Formatter: Pretty console output","description":"Implement PrettyFormatter with colored, indented console output. Show pass/fail markers, step durations, error details for failures, skipped step indicators, and summary counts at the end.","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:28Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["format"],"dependencies":[{"issue_id":"moonspec-4ig","depends_on_id":"moonspec-o9h","type":"blocks","created_at":"2026-02-21T17:15:43Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-7og","title":"DocString support in step arguments","description":"Support DocString arguments in step definitions. When a Gherkin step has an attached doc string (triple-quoted block), it should be accessible to the step handler as a string argument. This was part of the original moonspec-mlp issue.","status":"open","priority":2,"issue_type":"feature","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-23T00:29:46Z","created_by":"Damian Reeves","updated_at":"2026-02-23T00:29:46Z"}
{"id":"moonspec-849","title":"Formatter: Cucumber Messages NDJSON output","description":"Implement MessagesFormatter that maps runner events to cucumber-messages Envelope types and writes NDJSON. Uses moonrockz/cucumber-messages package. Enables integration with Cucumber ecosystem tools.","status":"closed","priority":2,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:28Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["format"],"dependencies":[{"issue_id":"moonspec-849","depends_on_id":"moonspec-o9h","type":"blocks","created_at":"2026-02-21T17:15:43Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-8nw","title":"Hook and Attachment envelope emission","description":"Emit the remaining 4 cucumber-messages envelope types:\n- Hook: emitted during glue registration for before/after hooks\n- TestRunHookStarted: emitted when a test run hook begins executing\n- TestRunHookFinished: emitted when a test run hook finishes executing  \n- Attachment: emitted for embedded screenshots, logs, or other artifacts\n\nThese are the last envelope types needed for full cucumber-messages protocol compliance. Split from moonspec-kyq which covered the other 18 types.","status":"open","priority":3,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-24T00:37:34Z","created_by":"Damian Reeves","updated_at":"2026-02-24T00:37:34Z"}
{"id":"moonspec-9ii","title":"Runner API: moonspec.run convenience function","description":"Implement the top-level run() function for use inside test blocks: moonspec.run!(MyWorld::new(), path). Parses features, creates runner with default config and pretty formatter, executes, raises on failure.","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:30Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["core"],"dependencies":[{"issue_id":"moonspec-9ii","depends_on_id":"moonspec-cmq","type":"blocks","created_at":"2026-02-21T17:15:45Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-9kp","title":"Core: Hooks trait","description":"Define the Hooks trait with before_scenario, after_scenario, before_step, after_step methods. All have default no-op implementations. Define ScenarioInfo and StepInfo types.","status":"closed","priority":2,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:24Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["core"],"dependencies":[{"issue_id":"moonspec-9kp","depends_on_id":"moonspec-s7i","type":"blocks","created_at":"2026-02-21T17:15:38Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-ajf","title":"Runner: Scenario Outline expansion","description":"Expand Scenario Outlines with Examples tables into concrete scenarios before execution. Each Examples row produces one scenario with placeholder values substituted. Generate unique test names including parameter values.","status":"closed","priority":2,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:26Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["runner"],"dependencies":[{"issue_id":"moonspec-ajf","depends_on_id":"moonspec-cmq","type":"blocks","created_at":"2026-02-21T17:15:41Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-btt","title":"Runner: Dry-run mode","description":"When config.dry_run is true, validate step bindings without executing handlers. Report undefined steps (no matching expression) and pending steps. Useful for checking feature file coverage.","status":"closed","priority":3,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:27Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["runner"],"dependencies":[{"issue_id":"moonspec-btt","depends_on_id":"moonspec-cmq","type":"blocks","created_at":"2026-02-21T17:15:42Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-cmq","title":"Runner: Scenario executor and lifecycle","description":"Implement Runner struct parameterized on World+Steps+Hooks. Implement scenario lifecycle: create world, register steps, run before_scenario hook, execute each step (match via cucumber-expressions, extract params, call handler), run after hooks. On step failure, skip remaining steps.","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:25Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["runner"],"dependencies":[{"issue_id":"moonspec-cmq","depends_on_id":"moonspec-2sy","type":"blocks","created_at":"2026-02-21T17:15:39Z","created_by":"Damian Reeves","metadata":"{}"},{"issue_id":"moonspec-cmq","depends_on_id":"moonspec-9kp","type":"blocks","created_at":"2026-02-21T17:15:40Z","created_by":"Damian Reeves","metadata":"{}"},{"issue_id":"moonspec-cmq","depends_on_id":"moonspec-s7i","type":"blocks","created_at":"2026-02-21T17:15:39Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-ct4","title":"CLI: moonspec command with subcommands","description":"Implement CLI entry point with subcommands: run (parse+execute), gen (generate _test.mbt files), check (dry-run validation), list (list scenarios with optional tag filter), fmt (format .feature files). Global options: --features, --tags, --format, --no-color.","status":"closed","priority":2,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:30Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["cli"],"dependencies":[{"issue_id":"moonspec-ct4","depends_on_id":"moonspec-4ig","type":"blocks","created_at":"2026-02-21T17:15:45Z","created_by":"Damian Reeves","metadata":"{}"},{"issue_id":"moonspec-ct4","depends_on_id":"moonspec-cmq","type":"blocks","created_at":"2026-02-21T17:15:45Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-cvz","title":"Runner: Tag expression parser and filtering","description":"Implement TagExpression::parse() for boolean tag expressions: @tag, not @tag, @a and @b, @a or @b, parenthesized groups. Implement TagExpression::matches(tags) for filtering scenarios.","status":"closed","priority":2,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:25Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["runner"],"dependencies":[{"issue_id":"moonspec-cvz","depends_on_id":"moonspec-cmq","type":"blocks","created_at":"2026-02-21T17:15:40Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-hkz","title":"Custom parameter type registration","description":"Support custom parameter type registration similar to cucumber-rs #[derive(Parameter)]. Users should be able to define their own parameter types beyond the built-in {int}, {float}, {word}, {string} types, with custom parsing logic. This was part of the original moonspec-mlp issue.","status":"closed","priority":2,"issue_type":"feature","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-23T00:29:36Z","created_by":"Damian Reeves","updated_at":"2026-02-24T00:37:33Z","closed_at":"2026-02-24T00:37:33Z","close_reason":"Implemented via Setup.add_param_type() and Setup.add_param_type_strings() in PR #7"}
{"id":"moonspec-kkv","title":"Project scaffolding: moon.mod.json, package structure, README","description":"Initialize the MoonBit project with moon.mod.json (name: moonrockz/moonspec), create package directories (src/core, src/runner, src/format, src/codegen, src/cmd/main), moon.pkg.json files for each package with correct dependencies, .gitignore, and CLAUDE.md.","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:23Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["setup"]}
{"id":"moonspec-kyq","title":"Message-stream pipeline: full cucumber-messages compliance","description":"## Summary\n\nLayer a full cucumber-messages streaming pipeline on top of the composable pipeline architecture introduced in moonspec-1e8.\n\n## Context\n\nmoonspec-1e8 introduces the canonical cucumber pipeline with distinct phases (FeatureCache → Pickle compilation → filtering → execution). This follow-on task adds message-stream compliance where every phase emits `Envelope` messages into an NDJSON stream.\n\n## Requirements\n\n- Each pipeline phase emits the appropriate cucumber-messages `Envelope` types:\n  - Discovery/Parse: `Source`, `GherkinDocument`, `ParseError`\n  - Compilation: `Pickle`\n  - Glue registration: `StepDefinition`, `Hook`, `ParameterType`\n  - Test planning: `TestCase`\n  - Execution: `TestRunStarted`, `TestCaseStarted`, `TestStepStarted`, `TestStepFinished`, `TestCaseFinished`, `TestRunFinished`\n  - Hooks: `TestRunHookStarted`, `TestRunHookFinished`\n  - Artifacts: `Attachment`\n  - Meta: `Meta`\n- Messages follow the canonical emission ordering defined by the cucumber-messages protocol\n- Formatters subscribe to the message stream rather than consuming results after the fact\n- NDJSON output support for interop with other cucumber ecosystem tools\n- The `cucumber-messages` package (already complete at v0.1.0) provides all necessary types\n\n## Dependencies\n\n- Depends on moonspec-1e8 (composable pipeline architecture)\n\n## Acceptance Criteria\n\n- [ ] All 21 cucumber-messages envelope types emitted at appropriate pipeline phases\n- [ ] NDJSON stream output available for external tool consumption\n- [ ] Formatters refactored to consume message stream\n- [ ] Message emission ordering matches canonical cucumber protocol spec\n- [ ] Existing tests continue to pass","status":"closed","priority":3,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-22T09:46:00Z","created_by":"Damian Reeves","updated_at":"2026-02-24T00:37:34Z","closed_at":"2026-02-24T00:37:34Z","close_reason":"18 of 21 envelope types implemented across PRs #6 and #7. Remaining Hook/Attachment envelopes tracked separately.","labels":["protocol","runner"],"dependencies":[{"issue_id":"moonspec-kyq","depends_on_id":"moonspec-1e8","type":"blocks","created_at":"2026-02-22T03:46:11Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-mlp","title":"Improved step definitions: align with cucumber ecosystem patterns","description":"## Summary\n\nImprove moonspec's step definition support to align with patterns established in the cucumber ecosystem, particularly cucumber-rs which also operates without runtime reflection.\n\n## Completed\n\n- Shared step definition pattern via StepLibrary trait — documented and tested\n- Ecommerce multi-feature example demonstrating StepLibrary composition (CartSteps, CheckoutSteps, InventorySteps)\n- Ecommerce CLI runner example demonstrating embedded runner with PrettyFormatter\n- Root README updated with multi-feature and embedding sections\n- Made formatter trait impls pub for cross-package use\n- Re-exported RunResult types through facade\n\n## Note\n\nRemaining acceptance criteria split into separate issues.","status":"closed","priority":2,"issue_type":"feature","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-22T21:11:54Z","created_by":"Damian Reeves","updated_at":"2026-02-23T00:29:17Z","closed_at":"2026-02-23T00:29:17Z","close_reason":"Completed: shared step definition pattern (StepLibrary) documented and tested with ecommerce examples + CLI runner. Remaining criteria split into separate issues.","labels":["cucumber","steps"],"dependencies":[{"issue_id":"moonspec-mlp","depends_on_id":"moonspec-kyq","type":"related","created_at":"2026-02-22T15:19:24Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-o9h","title":"Formatter: Formatter trait","description":"Define the Formatter trait with event-driven methods: on_run_start, on_feature_start, on_scenario_start, on_step_finish, on_scenario_finish, on_feature_finish, on_run_finish. Runner notifies all registered formatters as events occur.","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:27Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["format"],"dependencies":[{"issue_id":"moonspec-o9h","depends_on_id":"moonspec-2sy","type":"blocks","created_at":"2026-02-21T17:15:42Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-pnk","title":"Unmatched step suggestions in error messages","description":"When a step has no matching definition, show closest matches in the error message (like cucumber-rs does). The UndefinedStep error should include 'did you mean?' suggestions based on fuzzy matching of registered step patterns. This was part of the original moonspec-mlp issue.","status":"open","priority":2,"issue_type":"feature","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-23T00:29:39Z","created_by":"Damian Reeves","updated_at":"2026-02-23T00:29:39Z"}
{"id":"moonspec-q7q","title":"Full cucumber expression support with typed parameters","description":"Ensure all cucumber expression parameter types are fully supported: {int}, {float}, {word}, {string}, and custom parameter types. Typed argument extraction from cucumber expressions should work correctly with StepArg variants. This was part of the original moonspec-mlp issue.","status":"open","priority":2,"issue_type":"feature","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-23T00:29:33Z","created_by":"Damian Reeves","updated_at":"2026-02-23T00:29:33Z"}
{"id":"moonspec-s7i","title":"Core: World and Steps traits","description":"Define the World trait (new() -\u003e Self), Steps trait (steps(Self, StepRegistry) -\u003e Unit), StepRegistry struct with given/when/then methods, StepHandler type, and StepArg enum (IntArg, FloatArg, StringArg, WordArg, CustomArg).","status":"closed","priority":1,"issue_type":"task","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-21T23:15:24Z","created_by":"Damian Reeves","updated_at":"2026-02-22T02:57:21Z","closed_at":"2026-02-22T02:57:21Z","close_reason":"Closed","labels":["core"],"dependencies":[{"issue_id":"moonspec-s7i","depends_on_id":"moonspec-kkv","type":"blocks","created_at":"2026-02-21T17:15:37Z","created_by":"Damian Reeves","metadata":"{}"}]}
{"id":"moonspec-sgg","title":"Compile-time attribute scanning CLI command for step definition codegen","description":"## Summary\n\nAdd a `moonspec gen` (or `moonspec scan`) CLI command that scans MoonBit source files for custom attributes (`#moonspec.given`, `#moonspec.when`, `#moonspec.then`) and generates `World::register_steps` implementations automatically. This command runs as a pre-build step.\n\n## Context\n\nMoonBit supports custom attributes that are compile-time only (no runtime reflection), but readable by external tools via source parsing. This enables a cucumber-rs-style attribute API without proc macros.\n\nThe World traits refactor plan (docs/plans/2026-02-22-world-traits-refactor.md) outlined this as a future enhancement. This issue formalizes it.\n\n## Target Developer Experience\n\n### Basic (using derive(Default)):\n\\`\\`\\`moonbit\nstruct MyWorld { mut cucumbers : Int } derive(Default)\n\n#moonspec.given(\"I have {int} cucumbers\")\nfn set_cucumbers(self : MyWorld, count : Int) -\u003e Unit {\n  self.cucumbers = count\n}\n\n#moonspec.when(\"I eat {int} cucumbers\")\nfn eat_cucumbers(self : MyWorld, count : Int) -\u003e Unit {\n  self.cucumbers = self.cucumbers - count\n}\n\n#moonspec.then(\"I should have {int} cucumbers\")\nfn check_cucumbers(self : MyWorld, count : Int) -\u003e Unit raise Error {\n  assert_eq(self.cucumbers, count)\n}\n\\`\\`\\`\n\n### Custom constructor:\n\\`\\`\\`moonbit\n#moonspec.world(init = Self::new)\nstruct AnimalWorld { mut cat : Cat }\n\\`\\`\\`\n\n## How It Works\n\n1. **`moonspec gen` scans source files** — parses `.mbt` files looking for `#moonspec.*` attributes on functions\n2. **Extracts metadata** — function name, cucumber expression pattern, parameter types, World type from `self` parameter\n3. **Generates `register_steps` impl** — auto-generates `impl World for MyWorld with register_steps(self, s) { ... }` block\n4. **Runtime API unchanged** — generated code calls `s.given(pattern, handler)` internally\n\n## Requirements\n\n### Attribute Parsing\n- Scan `.mbt` files for `#moonspec.given(expr)`, `#moonspec.when(expr)`, `#moonspec.then(expr)` attributes\n- Scan for `#moonspec.world(init = ...)` on struct declarations\n- Parse function signatures to extract parameter types and World type from `self`\n- MoonBit source parser or AST access needed\n\n### Code Generation\n- Generate `impl World for \u003cType\u003e with register_steps(self, s) { ... }` blocks\n- Map function parameter types (Int, String, Double) to cucumber expression types ({int}, {string}, {float})\n- Support `#moonspec.world(init = Self::new)` for custom constructors (instead of Default::default())\n- Output generated code to a well-known location (e.g., `_generated/steps.mbt`)\n\n### Pre-Build Integration\n- CLI command: `moonspec gen [--dir src/] [--out _generated/]`\n- Can be wired into `moon.pkg.json` pre-build or a mise task\n- Incremental: only regenerate when source files change (extend existing hash-based staleness detection from feature codegen)\n\n### Safety\n- Conflict detection: warn when both manual `register_steps` and attributes exist for same World type\n- Clear error messages for malformed attributes or unsupported parameter types\n\n## Dependencies\n\n- Depends on moonspec-mlp (improved step definitions / runtime API must be solid first)\n\n## Acceptance Criteria\n\n- [ ] `moonspec gen` command scans `.mbt` files for `#moonspec.*` attributes\n- [ ] Generates correct `register_steps` implementation\n- [ ] Custom constructor support via `#moonspec.world(init = ...)`\n- [ ] Type-safe argument mapping from function params to cucumber expressions\n- [ ] Incremental generation (hash-based staleness)\n- [ ] Conflict detection for manual + generated registration\n- [ ] Integration with pre-build step documented","notes":"Design approved. Promoted to epic with 3 phases: CLI refactoring, hierarchical config, attribute scanning. Design doc: docs/plans/2026-02-22-step-codegen-design.md","status":"closed","priority":2,"issue_type":"feature","owner":"957246+DamianReeves@users.noreply.github.com","created_at":"2026-02-22T21:12:12Z","created_by":"Damian Reeves","updated_at":"2026-02-23T02:16:49Z","closed_at":"2026-02-23T02:16:49Z","close_reason":"All 9 tasks implemented: CLI refactoring, config package, JSON schema, parser dependency, scanner, codegen, CLI wiring, conflict detection, e2e test. 130 tests passing.","labels":["cli","codegen","steps"],"dependencies":[{"issue_id":"moonspec-sgg","depends_on_id":"moonspec-mlp","type":"blocks","created_at":"2026-02-22T15:12:16Z","created_by":"Damian Reeves","metadata":"{}"}]}
