///|
test "generate_configure produces valid impl block" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "given",
      pattern: "I have {int} cucumbers",
      fn_name: "set_cucumbers",
      world_type: "MyWorld",
      params: [{ name: "count", type_name: "Int" }],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 2,
    },
  ]
  let output = generate_configure("MyWorld", steps, source_hash="abcd1234")
  // Check header
  assert_true(str_contains(output, "// Generated by moonspec gen steps"))
  assert_true(str_contains(output, "// moonspec:hash:abcd1234"))
  // Check impl block
  assert_true(
    str_contains(
      output, "impl @moonspec.World for MyWorld with configure(self, setup)",
    ),
  )
  // Check typed step registration
  assert_true(str_contains(output, "setup.given1(\"I have {int} cucumbers\""))
  // Check typed lambda parameter
  assert_true(str_contains(output, "_arg0 : Int"))
  // Check function call
  assert_true(str_contains(output, "set_cucumbers(self, _arg0)"))
}

///|
test "generate_configure handles multiple params" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "when",
      pattern: "I eat {int} of {string}",
      fn_name: "eat_food",
      world_type: "W",
      params: [
        { name: "count", type_name: "Int" },
        { name: "food", type_name: "String" },
      ],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 5,
    },
  ]
  let output = generate_configure("W", steps, source_hash="00000000")
  // Check arity-suffixed method
  assert_true(str_contains(output, "setup.when2("))
  // Check typed lambda parameters
  assert_true(str_contains(output, "_arg0 : Int"))
  assert_true(str_contains(output, "_arg1 : String"))
  // Check function call with both args
  assert_true(str_contains(output, "eat_food(self, _arg0, _arg1)"))
}

///|
test "generate_configure handles no-param steps" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "when",
      pattern: "they log in",
      fn_name: "login",
      world_type: "W",
      params: [],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 3,
    },
  ]
  let output = generate_configure("W", steps, source_hash="00000000")
  // Check arity-0 method
  assert_true(str_contains(output, "setup.when0("))
  // Check empty lambda params
  assert_true(str_contains(output, "fn() {"))
  // Check function call
  assert_true(str_contains(output, "login(self)"))
}
