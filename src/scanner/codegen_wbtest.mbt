///|
fn str_contains(haystack : String, needle : String) -> Bool {
  let h_len = haystack.length()
  let n_len = needle.length()
  if n_len == 0 {
    return true
  }
  if n_len > h_len {
    return false
  }
  for i = 0; i <= h_len - n_len; i = i + 1 {
    let mut found = true
    for j = 0; j < n_len; j = j + 1 {
      if haystack[i + j] != needle[j] {
        found = false
        break
      }
    }
    if found {
      return true
    }
  }
  false
}

test "generate_register_steps produces valid impl block" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "given",
      pattern: "I have {int} cucumbers",
      fn_name: "set_cucumbers",
      world_type: "MyWorld",
      params: [{ name: "count", type_name: "Int" }],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 2,
    },
  ]
  let output = generate_register_steps("MyWorld", steps, source_hash="abcd1234")
  // Check header
  assert_true(str_contains(output, "// Generated by moonspec gen steps"))
  assert_true(str_contains(output, "// moonspec:hash:abcd1234"))
  // Check impl block
  assert_true(
    str_contains(
      output,
      "impl @moonspec.World for MyWorld with register_steps(self, s)",
    ),
  )
  // Check step registration
  assert_true(str_contains(output, "s.given(\"I have {int} cucumbers\""))
  // Check function call
  assert_true(str_contains(output, "set_cucumbers(self"))
  // Check arg extraction
  assert_true(str_contains(output, "IntArg(v)"))
}

test "generate_register_steps handles multiple params" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "when",
      pattern: "I eat {int} of {string}",
      fn_name: "eat_food",
      world_type: "W",
      params: [
        { name: "count", type_name: "Int" },
        { name: "food", type_name: "String" },
      ],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 5,
    },
  ]
  let output = generate_register_steps("W", steps, source_hash="00000000")
  assert_true(str_contains(output, "args[0]"))
  assert_true(str_contains(output, "args[1]"))
  assert_true(str_contains(output, "StringArg(v)"))
}

test "generate_register_steps handles no-param steps" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "when",
      pattern: "they log in",
      fn_name: "login",
      world_type: "W",
      params: [],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 3,
    },
  ]
  let output = generate_register_steps("W", steps, source_hash="00000000")
  assert_true(str_contains(output, "login(self)"))
  // Should not have any arg extraction
  assert_true(not(str_contains(output, "args[")))
}
