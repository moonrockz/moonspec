///|
test "generate_configure produces valid impl block" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "given",
      pattern: "I have {int} cucumbers",
      fn_name: "set_cucumbers",
      world_type: "MyWorld",
      params: [{ name: "count", type_name: "Int" }],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 2,
    },
  ]
  let output = generate_configure("MyWorld", steps, source_hash="abcd1234")
  // Check header
  assert_true(str_contains(output, "// Generated by moonspec gen steps"))
  assert_true(str_contains(output, "// moonspec:hash:abcd1234"))
  // Check impl block
  assert_true(
    str_contains(
      output, "impl @moonspec.World for MyWorld with configure(self, setup)",
    ),
  )
  // Check step registration
  assert_true(str_contains(output, "setup.given(\"I have {int} cucumbers\""))
  // Check function call
  assert_true(str_contains(output, "set_cucumbers(self"))
  // Check arg extraction
  assert_true(str_contains(output, "IntVal(v)"))
}

///|
test "generate_configure handles multiple params" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "when",
      pattern: "I eat {int} of {string}",
      fn_name: "eat_food",
      world_type: "W",
      params: [
        { name: "count", type_name: "Int" },
        { name: "food", type_name: "String" },
      ],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 5,
    },
  ]
  let output = generate_configure("W", steps, source_hash="00000000")
  assert_true(str_contains(output, "ctx[0]"))
  assert_true(str_contains(output, "ctx[1]"))
  assert_true(str_contains(output, "StringVal(v)"))
}

///|
test "generate_configure handles no-param steps" {
  let steps : Array[StepFnInfo] = [
    {
      keyword: "when",
      pattern: "they log in",
      fn_name: "login",
      world_type: "W",
      params: [],
      is_method: true,
      raises: false,
      source_file: "src/steps.mbt",
      line: 3,
    },
  ]
  let output = generate_configure("W", steps, source_hash="00000000")
  assert_true(str_contains(output, "login(self)"))
  // Should not have any arg extraction
  assert_true(not(str_contains(output, "ctx[")))
}
