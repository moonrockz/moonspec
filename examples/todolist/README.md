# TodoList Example

Attribute-based step registration example using `#moonspec.given/when/then`
annotations and `moonspec gen steps` code generation.

## What This Example Shows

- **Attribute-based steps**: Step functions annotated with `#moonspec.given`,
  `#moonspec.when`, and `#moonspec.then` instead of manual `configure`
- **World attribute**: `#moonspec.world` marks the struct as a World type
- **Step codegen**: `moonspec gen steps` generates the `configure`
  implementation from annotated functions
- **Test codegen**: `moonspec gen tests` generates one `async test` per scenario
- **Pre-build integration**: Both codegen steps configured in `moon.pkg` so
  everything regenerates automatically on build
- **Cucumber Expressions**: `{string}` and `{int}` parameters with type-safe
  extraction

## Project Structure

```
todolist/
├── moon.mod.json
├── moonspec.json5                     # Codegen config: world, mode, steps output
├── features/
│   └── todolist.feature               # 4 scenarios
└── src/
    ├── moon.pkg                       # Imports + pre-build steps
    ├── world.mbt                      # TodoWorld with #moonspec.world
    ├── steps.mbt                      # Step functions with #moonspec.given/when/then
    ├── todoworld_steps_gen.mbt        # Generated by moonspec gen steps
    └── todolist_feature_wbtest.mbt    # Generated by moonspec gen tests
```

## Attribute-Based Steps

Instead of writing a manual `configure` implementation, annotate your
step functions directly:

```moonbit
#moonspec.given("a todo list")
fn given_todo_list(world : TodoWorld) -> Unit {
  world.todos.clear()
}

#moonspec.when("I add a todo {string}")
fn when_add_todo(world : TodoWorld, title : String) -> Unit {
  world.todos.push(TodoItem::{ title, completed: false })
}

#moonspec.then("I should have {int} todos")
fn then_todo_count(world : TodoWorld, count : Int) -> Unit raise Error {
  assert_eq(world.todos.length(), count)
}
```

The `#moonspec.world` attribute marks the World struct:

```moonbit
#moonspec.world
struct TodoWorld {
  todos : Array[TodoItem]
} derive(Default)
```

Running `moonspec gen steps -d src/` scans these annotations and generates
`todoworld_steps_gen.mbt` with the full `configure` implementation.

## Pre-Build Configuration

Both codegen steps are configured in `moon.pkg` so they run automatically:

```
options(
  "pre-build": [
    {
      "input": "../features/todolist.feature",
      "output": "todolist_feature_wbtest.mbt",
      "command": "moonspec gen tests $input -w TodoWorld -o .",
    },
    {
      "input": "steps.mbt",
      "output": "todoworld_steps_gen.mbt",
      "command": "moonspec gen steps -d .",
    },
  ],
)
```

The generated files are pre-committed so the example works without the
moonspec CLI installed.

## Running

```bash
moon test --target js
```

Expected output:

```
Total tests: 4, passed: 4, failed: 0.
```
